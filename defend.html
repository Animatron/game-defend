<!DOCTYPE html>
<html>
	<head>
		<title>Tower Defense - Animatron HTML5 Player Demo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="../player/vendor/matrix.js" type="text/javascript"></script>
		<script src="../player/anm.player.js" type="text/javascript"></script>
		<script src="../player/anm.builder.js" type="text/javascript"></script>
		<script src="../player/animatron_import.js" type="text/javascript"></script>

		<script type="text/javascript">
			var b = Builder._$, B = Builder, C = anm.C;
			
			// canvas
			var width = 640;
			var height = 480;
			var scene1 = b();
			
			var precision = 4;
			
			var target = [0, 0];
			
			var flag = false;
			
			function Rectangle(x1, y1, x2, y2) {
				this.x1 = x1;
				this.y1 = y1;
				this.x2 = x2;
				this.y2 = y2;
			}
			
			var block = [new Rectangle(64, 48, 128, 160)]; // this will be preset, arrays of rectangles
			var turret = new Array();
			var grid = new Array(); // height vs width
			
			// create grid
			grid = new Array(height/precision);
			for (var i=0; i<height/precision; i++) {
				grid[i] = new Array(width/precision);
				for (var j=0; j<width/precision; j++)
					grid[i][j] = 0;
			}
			// fill with blocks
			for (var i=0; i<block.length; i++) {
				var k = block[i];
				for (var y=k.y1/precision; y<k.y2/precision; y++) {
					for (var x=k.x1/precision; x<k.x2/precision; x++)
						grid[y][x] = 1;
				}
			}
			
			//for (var i=0; i<height/precision; i++)
			//	console.log(grid[i]);
			
			// A* implementation based on http://webreflection.blogspot.com/2006/10/javascript-path-finder-with-star.html
			
			function successors(x, y, rows, cols){
				var
					N = y - 1,
					S = y + 1,
					E = x + 1,
					W = x - 1,
					$N = N > -1 && !grid[N][x],
					$S = S < rows && !grid[S][x],
					$E = E < cols && !grid[y][E],
					$W = W > -1 && !grid[y][W],
					result = [],
					i = 0
				;
				$N && (result[i++] = {x:x, y:N});
				$E && (result[i++] = {x:E, y:y});
				$S && (result[i++] = {x:x, y:S});
				$W && (result[i++] = {x:W, y:y});
				return result;
			}
			
			function distanceTo(start, end) {
				// divide weight by turret distance
				var risk = 0;
				if (turret.length > 0)
				for (var t in turret) {
					var d = t.data();
					risk += Math.sqrt(Math.pow(start.x - d.x, 2) + Math.pow(start.y - d.y, 2))
				}
        		return (Math.abs(start.x - end.x) + Math.abs(start.y - end.y)) / (risk+1);
    		}
					
			function AStar(start, end) {
				var
					cols = grid[0].length,
					rows = grid.length,
					limit = cols * rows,
					list = {},
					result = [],
					open = [{x:start[0], y:start[1], f:0, g:0, v:start[0]+start[1]*cols}],
					length = 1,
					adj, distance, i, j, max, min, current, next
				;
				end = {x:end[0], y:end[1], v:end[0]+end[1]*cols};
				
				do {
					max = limit;
					min = 0;
					for(i = 0; i < length; ++i) {
						if((f = open[i].f) < max) {
							max = f;
							min = i;
						}
					};
					current = open.splice(min, 1)[0];
					if (current.v != end.v) {
						--length;
						next = successors(current.x, current.y, grid, rows, cols);
						for(i = 0, j = next.length; i < j; ++i){
							(adj = next[i]).p = current;
							adj.f = adj.g = 0;
							adj.v = adj.x + adj.y * cols;
							if(!(adj.v in list)){
								adj.f = (adj.g = current.g + distanceTo(adj, current)) + distanceTo(adj, end);
								open[length++] = adj;
								list[adj.v] = 1;
							}
						}
					} else {
						i = length = 0;
						do {
							result[i++] = [current.x, current.y];
						} while (current = current.p);
						result.reverse();
					}
				} while (length);
				return result;
			}
			
			var boxModifier = function(t) {
				if (!flag) {
				var speed = 1;
				var x = b(this.$).data().x;
				var y = b(this.$).data().y;
				var next = AStar([Math.floor(x/precision), Math.floor(y/precision)], target);
				flag = true;
					console.log(x, y, this.x, this.y, next[1]);
				this.x = x + (next[1][0]*precision - x)*speed;
				this.y = y + (next[1][1]*precision - y)*speed;
				b(this.$).data({'x':this.x, 'y':this.y});
				}
			}
			
			function box(xi, yi) {
				return b().rect([xi+precision/2, yi+precision/2], [precision, precision]).fill('#000').data({'x':xi, 'y':yi}).modify(boxModifier);
			}
			
            function start() {
				scene1.add(box(400, 400));
				
				createPlayer('canvas', {'mode': C.M_DYNAMIC}).load(scene1).play();
            }
        </script>
      </head>

	<body onload="start();">
		<h1>Tower Defense - Animatron HTML5 Player Demo</h1>

		<!-- canvases -->
		<canvas id="canvas" width="640" height="480"></canvas>

	</body>

</html>