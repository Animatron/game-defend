<!DOCTYPE html>
<html>
	<head>
		<title>Tower Defense - Animatron HTML5 Player Demo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="../player/vendor/matrix.js" type="text/javascript"></script>
		<script src="../player/anm.player.js" type="text/javascript"></script>
		<script src="../player/anm.builder.js" type="text/javascript"></script>
		<script src="../player/animatron_import.js" type="text/javascript"></script>

		<script type="text/javascript">
			var b = Builder._$, B = Builder, C = anm.C;
			
			// canvas
			var width = 640;
			var height = 480;
			var scene1 = b();
			
			var block = new Array();
			
			// A* implementation from http://webreflection.blogspot.com/2006/10/javascript-path-finder-with-star.html
			
			function successors(x, y, grid, rows, cols){
				var
					N = y - 1,
					S = y + 1,
					E = x + 1,
					W = x - 1,
					$N = N > -1 && !grid[N][x],
					$S = S < rows && !grid[S][x],
					$E = E < cols && !grid[y][E],
					$W = W > -1 && !grid[y][W],
					result = [],
					i = 0
				;
				$N && (result[i++] = {x:x, y:N});
				$E && (result[i++] = {x:E, y:y});
				$S && (result[i++] = {x:x, y:S});
				$W && (result[i++] = {x:W, y:y});
				return result;
			}
			
			function distance(start, end, f1, f2) {
        		return f1(start.x - end.x) + f1(start.y - end.y);
    		}
					
			function AStar(grid, start, end) {
				var
					cols = grid[0].length,
					rows = grid.length,
					limit = cols * rows,
					f1 = Math.abs,
					f2 = Math.max,
					list = {},
					result = [],
					open = [{x:start[0], y:start[1], f:0, g:0, v:start[0]+start[1]*cols}],
					length = 1,
					adj, distance, i, j, max, min, current, next
				;
				end = {x:end[0], y:end[1], v:end[0]+end[1]*cols};
				
				do {
					max = limit;
					min = 0;
					for(i = 0; i < length; ++i) {
						if((f = open[i].f) < max) {
							max = f;
							min = i;
						}
					};
					current = open.splice(min, 1)[0];
					if (current.v != end.v) {
						--length;
						next = successors(current.x, current.y, grid, rows, cols);
						for(i = 0, j = next.length; i < j; ++i){
							(adj = next[i]).p = current;
							adj.f = adj.g = 0;
							adj.v = adj.x + adj.y * cols;
							if(!(adj.v in list)){
								adj.f = (adj.g = current.g + distance(adj, current, f1, f2)) + distance(adj, end, f1, f2);
								open[length++] = adj;
								list[adj.v] = 1;
							}
						}
					} else {
						i = length = 0;
						do {
							result[i++] = [current.x, current.y];
						} while (current = current.p);
						result.reverse();
					}
				} while (length);
				return result;
			}
			
            function start() {
				
				createPlayer('canvas', {'mode': C.M_DYNAMIC}).load(scene1).play();
            }
        </script>
      </head>

	<body onload="start();">
		<h1>Tower Defense - Animatron HTML5 Player Demo</h1>

		<!-- canvases -->
		<canvas id="canvas" width="640" height="480"></canvas>

	</body>

</html>